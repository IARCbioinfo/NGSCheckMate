version: 2.1
#orbs:
#  singularity: singularity/singularity@1.0.10

jobs:
  build:
        machine: true
        steps:
                - checkout
                - run: sudo apt-get install graphviz
                - run: cd ~ ; wget -qO- get.nextflow.io | bash ; chmod 755 nextflow ; sudo ln -s ~/nextflow /usr/local/bin/ 
                - run: echo " docker.runOptions = '-u $(id -u):$(id -g)' " > ~/.nextflow/config
                - run: cd ~/project/ ; docker build -t iarcbioinfo/ngscheckmate-nf .
                #; sudo apt-get install libarchive-dev
#                - run: sudo rm -rf /usr/local/go
#                - run: cd ~ ; export VERSION=1.13 OS=linux ARCH=amd64; wget https://dl.google.com/go/go$VERSION.$OS-$ARCH.tar.gz; sudo tar -C /usr/local -xzvf go$VERSION.$OS-$ARCH.tar.gz ; rm go$VERSION.$OS-$ARCH.tar.gz; sudo ln -s /usr/local/go/bin/go /usr/local/bin/
#                - run: which go; go version; go env
#                - run: cd ~ ; VERSION=3.6.0; wget https://github.com/sylabs/singularity/releases/download/v${VERSION}/singularity-${VERSION}.tar.gz; tar -xzf singularity-${VERSION}.tar.gz; cd singularity; ./mconfig; make -C builddir; sudo make -C builddir install                         
#                - run: cd ~ ; singularity pull ...
                - run: cd ~ && git clone https://github.com/iarcbioinfo/data_test.git
                - run: cd ; mkdir BAM; ln -s ~/data_test/BAM/NA06984_N.bam* BAM/.
                - run: cd ; nextflow run ~/project/ --help
                - run: cd ; nextflow run ~/project/ -with-docker iarcbioinfo/ngscheckmate-nf --input_folder BAM/ --output_folder NCM-out --ref ~/data_test/REF/17_7572000-7591000.fasta --bed ~/data_test/BED/SNP_GRCh38_4NCM.bed --cpu 2 --mem 4 -with-dag dag.html
                - run: cd ; cp ~/dag.* ~/project/.
                - add_ssh_keys:
                                fingerprints:
                                        - "2d:55:7c:ec:4c:fc:32:25:ff:20:cb:08:a8:ee:e4:bc"
                - deploy:
                        branch: [master, dev]
                        command: chmod +x deploy.sh && ./deploy.sh

workflows:
  install_s_build_and_test:
    jobs:
      - build